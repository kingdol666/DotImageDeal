# Dark Particle Analyzer

一个用于在图像中自动识别并标记“暗色颗粒（点）”的简单 GUI 工具。基于 Pillow 与 PyQt6，提供交互式选区处理与批量处理功能。

## 主要功能
- 交互式 GUI：加载图像、在图像上通过拖拽选择区域进行检测并高亮显示结果。
- 参数可调：灵敏度、局部背景模糊半径、边框忽略宽度、最小/最大颗粒面积等。
- 批量处理：对多个图像应用相同参数并生成带标记的输出文件。
- 主题切换：深色/浅色主题切换（依赖 style.qss / style_light.qss）。
- 支持常见图像格式：PNG/JPG/BMP。

## 依赖
- Python 3.8+
- Pillow
- PyQt6

安装依赖示例：
```bash
pip install Pillow PyQt6
```

## 运行
从项目根目录运行 GUI：
```bash
python src/gui.py
```
或者指定完整路径运行。

## 使用说明（GUI）
1. 点击 “Load Image” 加载图像。  
2. 在左侧图像上用鼠标左键拖拽选取要分析的矩形区域。释放鼠标后程序会自动处理该选区并在右侧显示带标记的结果。左侧仍显示带选区边框的原图。  
3. 可通过界面下方或顶部的控件调节参数（灵敏度、模糊半径、边框宽度、最小/最大颗粒面积），参数改动会触发重新处理（选区需存在）。  
4. 点击 “Save Result” 保存当前处理结果图像。  
5. 批量处理：点击 “Batch Process” 选择多个图像，设置批量输出目录（右侧目录选择控件），程序会在批量处理中为每张图生成带后缀 `_marked` 的输出图像。  
6. “Toggle Theme” 可在深色与浅色样式表之间切换（请确保样式表文件位于 src/ 下）。

## 参数说明
- Sensitivity（识别灵敏度）：范围 0.0 ~ 1.0，越大识别越宽松（标记越多）。  
- Blur Radius（模糊半径）：用于计算局部背景亮度的模糊半径，应大于目标颗粒最大半径。  
- Border Width（边框宽度）：忽略图像边缘的宽度（像素），该区域内的内容不会被标记。  
- Min/Max Particle Size（最小/最大颗粒面积）：以像素为单位过滤检测到的颗粒。设为 0 则不限制最大/最小。

## 批量处理说明
- 选择要处理的图像列表后，程序会要求设置输出目录（默认项目下 `output`）。  
- 每张输入图像会生成一个以 `_marked` 为后缀的输出文件，保存到所选目录。  
- 处理过程中会显示进度对话框，可取消中断。

## 常见问题与排查
- 无法加载样式表（style.qss / style_light.qss）：程序会打印错误提示，但不会阻止运行。确保这两个文件位于 `src/` 目录或删除样式加载逻辑。  
- 无响应或无法选区：确认已成功加载图像，并在显示区域能看到图像；选择矩形太小（宽高 <=1）会被忽略。  
- 批量输出无效或保存失败：确认选择的输出目录存在且有写权限。  
- 如果遇到异常堆栈，请查看终端输出以获得完整错误信息，定位问题来自 `main.mark_dark_particles_adaptive` 的调用或图像处理步骤。

## 开发与扩展
- 主要检测逻辑在 `src/main.py` 中（函数名 `mark_dark_particles_adaptive`），可在该处修改或替换检测算法。  
- 若希望将 GUI 打包为可执行文件，建议使用 PyInstaller 或类似工具。

## 许可证
请根据自己的需求添加合适的许可证（例如 MIT、Apache 等）。

如果需要 README 增加使用截图、示例结果或更详细的 API 文档，我可以继续补充。